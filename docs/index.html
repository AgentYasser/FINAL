<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>GTM Director AI Assistant (UAE B2B)</title>
  <style>
    body { font-family: sans-serif; max-width: 700px; margin: 30px auto; }
    #log { border: 1px solid #ddd; height: 400px; overflow-y: auto; padding: 15px; }
    .system { color: grey; }
    .user { color: blue; margin-top: 10px; }
    .assistant { color: green; margin-top: 10px; }
    textarea { width: 100%; height: 60px; margin-top: 10px; padding: 10px; box-sizing: border-box; }
    button { padding: 8px 16px; }
  </style>
</head>
<body>

  <h2>e& B2B GTM Director AI Assistant (UAE)</h2>

  <div id="log"></div>

  <textarea id="input" placeholder="Say somethingâ€¦"></textarea><br/>
  <button id="send">Send</button>

<script>
const webhookURL = 'https://doumani.app.n8n.cloud/webhook/webhook-test/52743fa3-c608-4f03-ba4e-c27bfe23e2a4';

let history = [
  {
    role: 'system',
    content: `You are an AI assistant specifically designed for the Director of Go-To-Market (GTM) strategy at e& in the UAE B2B sector. 
GTM ALWAYS means "Go-To-Market" and NEVER "Google Tag Manager". Provide clear strategic recommendations and actionable steps.`
  }
];

const log = document.getElementById('log');
const input = document.getElementById('input');

function render() {
  log.innerHTML = '';
  history.forEach(msg => {
    let div = document.createElement('div');
    div.className = msg.role;
    div.innerHTML = `<strong>${msg.role}:</strong> ${msg.content}`;
    log.appendChild(div);
  });
  log.scrollTop = log.scrollHeight;
}

async function send() {
  const message = input.value.trim();
  if (!message) return;

  history.push({ role: 'user', content: message });
  render();
  input.value = '';

  const res = await fetch(webhookURL, {
    method: 'POST',
    headers: { 'Content-Type': 'application/json' },
    body: JSON.stringify({ message })
  });

  const data = await res.json();

  let assistantMsg = '';
  
  // Correctly handle the object returned from n8n webhook
  if (Array.isArray(data) && data.length > 0) {
    data.forEach(item => {
      if (item.reply) {
        // If reply is an object, stringify neatly
        if (typeof item.reply === 'object') {
          assistantMsg += JSON.stringify(item.reply, null, 2);
        } else {
          assistantMsg += item.reply;
        }
      } else if (item.message) {
        assistantMsg += item.message;
      } else {
        assistantMsg += JSON.stringify(item);
      }
    });
  } else {
    assistantMsg = "Sorry, I couldn't process that clearly. Please try again.";
  }

  history.push({ role: 'assistant', content: assistantMsg });
  render();
}

document.getElementById('send').onclick = send;
render();
</script>

</body>
</html>
